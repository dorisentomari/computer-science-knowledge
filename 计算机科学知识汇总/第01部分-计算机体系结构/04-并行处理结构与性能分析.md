# 1. 并行编程基础

## 1.1 程序的并行行为

### 1.1.1 指令级并行性

指令级并行性(Instruction Level Parallelism，ILP) 主要指指令之间的并行执行，当前指令存在相关时，这些指令可以在处理器流水线上重叠起来并行执行。

在程序运行中，如果必须等前一条指令执行完毕后，再能执行后一条指令，那么这两条指令时相关的。

**指令相关主要包括：数据相关、控制相关和结构相关**

+ 数据相关：
    + 写后读(Read After Write)，真正的数据相关，因为存在真正的数据传递关系
    + 读后写(Write After Read)
    + 写后写(Write After Write)
+ 控制相关：
    + 由于存在分支指令，一条指令的执行取决于该分支指令的执行结果，则这两条指令之间存在控制相关
+ 结构相关：
    + 指两条指令同时需要流水线中的同一个功能部件。

**现代处理器采用多种微结构设计技术挖掘指令并行性，包括指令流水线、多发射、动态调度、寄存器重命名、转移猜测技术**

+ 指令流水线重叠执行多条不相关的指令
+ 多发射技术允许一个时钟周期执行多条指令，类似于多车道
+ 动态调度允许后续指令超过前面被阻塞的指令继续被调度执行，相当于允许超车
+ 寄存器重命名主要解决 RAW 和 WAW 的假相关问题
+ 转移猜测技术可以猜测分支指令的方向和目标，在分支指令还未执行完之前获取更多可执行指令，以减少控制相关造成的指令流水线阻塞。


### 1.1.2 数据级并行性
+ 数据级并行性(Data Level Parallelism，DLP) 是指对集合或者数组中的元素同时执行相同的操作。
+ 数据级并行性比较易于处理，可以在计算机体系结构的多个层次来利用数据级并行性。

### 1.1.3 任务级并行性

+ 任务级并行性时将不同的任务(进程或者线程)分布到不同的处理单元上执行。
+ 针对任务表现分为进程或者线程，任务级并行性可以分为内进程级或线程级并行性。

## 1.2 并行编程模型
+ 并行编程模型是一种程序抽象的集合，它给程序员提供了一幅计算机硬件/软件系统的抽象简图，利用这些模型可以为多核处理器、多处理器、机群等并行计算系统设计并行程序。

### 1.2.1 单任务数据并行模型

数据并行模型是指对集合或数组中的元素同时执行相同的操作。

数据并行编程模型可以在 SIMD 计算机上实现，为单任务数据并行，也可以在 SPMD 计算机上实现，为多任务数据模型。

SIMD 着重开发指令级细粒度的并行性，SPMD 着重开发子程序级中粒度的并行性

### 1.2.2 多任务共享存储编程模型

运行在各个处理器上的进程/线程可以通过读/写共享存储器中的共享变量来互相通信。

### 1.2.3 多任务消息传递编程模型

特点：

+ 多进程：消息传递并行程序由多个进程组成，每个进程都有自己的控制流且可执行不同代码，多程序多数据并行和单程序多数据并行均可支持
+ 异步并行性
+ 独立的地址空间
+ 显示互相作用
+ 显示分配


# 2. 多处理器结构

## 2.1 多核处理器的发展演化

多核处理器在单芯片上集成多个处理器核，包括通用多核处理器、异构多核处理器、众核处理器，主要通过聚合芯片上的多个处理器核的计算能力来提高应用程序执行性能。

多核处理器是在多处理器系统上发展的，其发展的主要驱动力包括以下三个方面：
 
+ 半导体工艺发展
+ 功耗墙问题
+ 并行结构的发展
    + 单指令多数据流(Single Instruction Multi Data，简称SIMD)结构
    + 对称多处理器(Symmetric Multi-Processor，简称 SMP)结构
    + 高速缓存一致非均匀存储器访问(Cache Coherent Non-Uniform Memory Access，简称 CC-NUMA)结构
    + MPP(Massive Parallel Processing) 系统
    + 机群系统

## 2.2 多核处理器的访存结构

### 2.2.1 通用多核处理器的片上 Cache 结构

片上 Cache 结构是通用多核处理器设计的重要内容。片上 Cache 的种类主要有：私有 Cache，共享 Cache，片间 Cache。

+ 私有 Cache：具有较快的访问速度，但是具有较高的流失率。
+ 共享 Cache：访问速度稍慢，但是具有失效率低优点。
+ 片间 Cache：访问速度慢，失效率高。

### 2.2.2 存储一致性结构

+ 顺序一致性
+ 处理器一致性
+ 弱一致性
+ 释放一致性

### 2.2.3 Cache 一致性协议

+ Cache 一致性协议的分类
    + 写无效协议与写更新协议
    + 侦听协议与目录协议
+ Cache 状态

## 2.3 多核处理器的互连结构

多核处理器通过片上互连将处理器核、Cache、内存控制器、IO 接口等模块连接起来。

+ 片上总线

片上总线主要用于多核处理器设计，它是片上各个部件间通信的公共通路，由一组线组成。

片上总线标准通常包括总线位宽、总线时序、总线仲裁等。

优点：实现简单，易于实现广播通信

缺点：可伸缩性不好 

+ 交叉开关

交叉开关可以看作一个以矩阵形式组织的开关集合。交叉开关有多个输入线和输出线，这些线交叉连接在一起，交叉点可以看做单个开关。当一个输入线与输出线的连接点处开关关闭时，则在输入线与输出线之间建立一个连接。

优点：高带宽，多对输入与输出端口建可以并行通信，且总带宽随所连接节点数的增加而增加。

缺点：随着连接节点数的增加，交叉开关需要的交叉点数目增加较快，物理实现代价高，复杂度为 O(M * N)，因为可伸缩性有限。

+ 片上网络

片上网络用来在处理器核节点间传输消息数据的互连网络体系结构。

借鉴了分布式网络的 TCP/IP 协议传输数据的方式，将数据封装成数据包，通过路由器之间的分组交换和对应的存储转发机制来实现处理器核间的通信。

片上网络的研究内容主要包括：拓扑结构，路由算法，流量控制，服务质量等

## 2.4 多核处理器的同步机制

常见的同步机制包括锁操作、栅障操作和事务内存。锁操作和事务内存主要用于保护临界区，栅障操作用于实现全局同步。锁操作和栅障操作属于传统同步方法，广泛应用于并发系统中。事务内存则是适应多核处理器设计需求的一种新同步机制。

+ 原子操作

原子指令的实现方式可以分为两种，一种是直接使用一条“读-改-写”(Read-Modify-Write，RMW)原子指令来完成，另一种是使用一组原子指令对 LL/SC(Load-Linked/Store-Conditional)来完成指定的原子操作。

LL/SC 原子指令对的优点在于设计简单，每条指令只需要和内存交互一次，且在 LL 指令和 SC 指令之间可以加入任意的运算指令。缺点在于密集共享时，SC 不容易成功。

+ 锁的软件实现方法

+ 栅障软件实现方法

+ 事务内存


# 3. 计算机系统性能评价指标

计算机系统的性能有很多衡量指标， 一般用于特定的场景，如执行时间或者响应时间、吞吐率、加速比、每条指令的时钟周期数(CPI)、每秒执行百万条指令数(MIPS)、每条执行百万浮点运算数(MFLOPS)、每秒执行的事务数(TPS)和归一化的执行时间等。

计算机的速度通过时钟频率(MHz 或 GHz) 来描述，表示 CPU 时钟的每秒时钟周期数。

CPU 时间 = 程序的 CPU 时钟周期数 * 时钟周期

CPU 时间 = 程序的 CPU 时钟周期数 / 时钟频率

CPI(Clock-cycles Per Instruction) 每条指令的时钟周期数，即平均每条指令执行需要花费多少个时钟周期

IPC(Instruction Per Clock)，CPI 的倒数，每个时钟周期内所执行的指令数

CPI = 程序的 CPU 时钟周期数 / 程序的执行指令数

## 3.1 并行系统的性能评价指标

+ 可扩展性：指的是随着并行系统中机器规模的扩大，并行系统的性能随之增长的特性。
+ 加速比：同一个任务在单处理器系统和并行处理器系统中运行所耗费时间的比率，用来衡量并行系统或程序并行化的性能和效果。

影响并行系统加速比的主要因素：计算时间和通信时间的占比与算法中计算复杂度和通信复杂度有关，也与并行系统的计算性能与通信性能有关。

## 3.2 测试程序集

### 3.2.1 计算机性能的测试程序
+ 真实的应用
+ 修改过的应用
+ 程序的核心部分
+ 轻量级玩具测试程序
+ 合成的测试程序
+ 基准测试程序集合
